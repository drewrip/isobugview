<!DOCTYPE html>
<html>
<textarea id="log_input">
</textarea>

      <button onclick="visualize();">Visualize Log</button>
      </html>
      <meta charset="utf-8">
      <style>

        .link {
            stroke: #454BA9;
            stroke-width: 1.5px;
        }

        .node {
            cursor: move;
            fill: #ccc;
            stroke: #000;
            stroke-width: 1.5px;
        }

        .node.fixed {
            fill: #f00;
        }

        textarea {
            height: 500px;
            width: 500px;
        }

    </style>
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="parser.js"></script>
    <script>

    function visualize(){
        let log = document.getElementById("log_input").value;

        // Remove any existing graph

        let curr_graphs = document.getElementsByTagName("svg");
        for(let i = 0; i < curr_graphs.length; i++){
            curr_graphs[i].remove();
        }
        

        render_graph(log);
    }

    function render_graph(log){

        let adj_list = genGraph(log);
        let g = getGraphLayout(adj_list);

        var svg = d3.select("body")
        .append("svg")
        .attr("width", (node_width * g.nodes.length) + 150)
        .attr("height", 400)
        .lower();

        width = +svg.attr("width"),
        height = +svg.attr("height");

        svg.append("defs").append("marker")
        .attr("id", "arrow")
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 30)
        .attr("refY", 0)
        .attr("markerWidth", 10)
        .attr("markerHeight", 10)
        .attr("orient", "auto")
        .append("svg:path")
        .attr("color", "grey")
        .attr("d", "M0,-5L10,0L0,5");

        let transactions = svg.selectAll(".txn_label")
        .data(g.txns)
        .enter()
        .append("text")
        .text(function(d){
            return d.txn;
        })
        .attr("class", "txn_label")
        .attr("x", function(d){
            return d.x;
        })
        .attr("y", function(d){
            return d.y;
        });

        var link = svg.selectAll("line")
        .data(g.links)
        .enter()
        .append("line")
        .attr("class", "links")
        .attr("x1", function(d){
            return d.source.x + (node_width/2);
        })
        .attr("y1", function(d){
            return d.source.y + (node_heigth/2);
        })
        .attr("x2", function(d){
            return d.target.x + (node_width/2);
        })
        .attr("y2", function(d){
            return d.target.y + (node_heigth/2);
        })
        .attr("stroke-width", 2)
        .attr("stroke", "grey")
        .attr("marker-end", "url(#arrow)")
        .on("mouseover", function(d, i){
            d3.select("#el"+i).attr("visibility", "visible");
            d3.select(this).attr("stroke", "orange");
        })
        .on("mouseout", function(d, i){
            d3.select("#el"+i).attr("visibility", "hidden");
            d3.select(this).attr("stroke", "grey");
        });

        var edge_labels = svg.selectAll(".labels")
        .data(g.links)
        .enter()
        .append("text")
        .text(function(d) {
            return d.source.type + d.target.type;
        })
        .attr('x', function(d) {
          return (d.source.x + d.target.x)/2;
        })
        .attr('y', function(d) {
          return (d.source.y + d.target.y)/2;
        })
        .attr("id", function(d, i){
            return "el" + i
        })
        .attr("visibility", "hidden");


        // Adding the nodes
        var node = svg.append("g")
        .attr("class", "nodes")
        .selectAll("g")
        .data(g.nodes)
        .enter().append("g");

        var rect = node.append("rect")
        .attr("x", function(d){
            return d.x;
        })
        .attr("y", function(d){
            return d.y;
        })
        .attr("width", node_width)
        .attr("height", node_heigth)
        .attr("rx", 5)
        .attr("ry", 5)
        .attr("stroke", "black")
        .attr("fill", "#FFFFFF")
        .attr("fill-width", 5);

        var node_labels = node.append("text")
        .text(function(d) {
          return d.type + "(" + d.op_num + ")";
        })
        .attr('x', function(d){
            return d.x + 10;
        })
        .attr('y', function(d){
            return d.y + 30;
        });

        node.append("title")
        .text(function(d) { return d.id; });

        svg.append("type").attr("class", "labels");


        var node = svg.append("g")
        .attr("class", "nodes")
        .selectAll("g")
        .data(g.nodes)
        .enter().append("g");

    }

    document.getElementById("log_input").value = default_test;

</script>
